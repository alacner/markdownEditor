(function(a){a.fn.input=function(a){var b=this;if(!a){return b.trigger("keydown.input")}return b.bind({"input.input":function(c){b.unbind("keydown.input");a.call(this,c)},"keydown.input":function(b){a.call(this,b)}})};a.fn.markdownEditor=function(b){b=a.extend({historyRate:2e3,renderRate:300,buttons:["b","i","a","blockquote","code","img","h","ul","undo","redo","help"],resources:{"md-btn-b":"Bold","md-btn-i":"Italic","md-btn-a":"Create link","md-btn-blockquote":"Quote","md-btn-code":"Code","md-btn-img":"Add image","md-btn-h":"Header","md-btn-ul":"Bullet list","md-btn-undo":"Undo","md-btn-redo":"Redo","md-btn-help":"Help","md-btn-accept":"Accept","md-btn-cancel":"Cancel"}},b);var c=[],d=0,e=new Showdown.converter,f=function(a){var c="md-btn-"+a;return'<a class="md-btn '+c+'" title="'+b.resources[c]+'"><span class="md-icon md-icon-'+a+'">'+b.resources[c]+"</span></a>"};$container=a('<div class="markdown-container"><div class="markdown-toolbar"></div><textarea class="markdown-editor"></textarea><div class="markdown-preview"></div></div>'),$toolbar=$container.find(".markdown-toolbar"),$editor=$container.find(".markdown-editor"),$preview=$container.find(".markdown-preview");var g=$editor[0],h=function(a,b,c){if(!c)return b;while(b>1){if(a[b-1]=="\n")break;b--}return b},i=function(a,b,c){if(!c)return b;while(b<a.length-1){if(a[b]=="\n")break;b++}return b},j="selectionStart"in g&&function(a){var b=h(g.value,g.selectionStart,a);var c=i(g.value,g.selectionEnd,a);var d=c-b;return{start:b,end:c,length:d,text:g.value.substr(b,d)}}||document.selection&&function(){g.focus();var a=document.selection.createRange();if(a===null){return{start:0,end:g.value.length,length:0}}var b=g.createTextRange();var c=b.duplicate();b.moveToBookmark(a.getBookmark());c.setEndPoint("EndToStart",b);return{start:c.text.length,end:c.text.length+a.text.length,length:a.text.length,text:a.text}}||function(){return null};var k="selectionStart"in g&&function(a,b){var c=h(g.value,g.selectionStart,b);var d=i(g.value,g.selectionEnd,b);g.value=g.value.substr(0,c)+a+g.value.substr(d,g.value.length);g.selectionStart=c;g.selectionEnd=c+a.length;g.focus()}||document.selection&&function(a){g.focus();document.selection.createRange().text=a}||function(a){g.value+=a};var l=0;var m=function(){clearTimeout(l);l=setTimeout(function(){if(g.value!=c[d]){c[++d]=g.value;if(c.length>d+1){c=c.slice(0,d+1);s.attr("disabled","")}}},b.historyRate);r.removeAttr("disabled");q()};var n=function(){if(d){g.value=c[--d];s.removeAttr("disabled");q()}d||r.attr("disabled","")};var o=function(){if(d<c.length-1){g.value=c[++d];if(d===c.length-1)s.attr("disabled","");q()}};var p=0;var q=function(a){if(!a){clearTimeout(p);p=setTimeout(function(){$preview.html(e.makeHtml(g.value))},b.renderRate)}else{$preview.html(e.makeHtml(g.value))}};a.each(b.buttons,function(a,b){$toolbar.append(f(b))});var r=$toolbar.find(".md-btn-undo");var s=$toolbar.find(".md-btn-redo");var t=function(b){var c=j().text.replace(/\n/g,"").trim(),d=a('<form class="md-link-form" action="#">'+'<input placeholder="Title" type="text" class="md-input md-title">'+'<input placeholder="http://" type="url" class="md-input md-href">'+f("accept")+f("cancel")+"</form>"),e=function(){d.remove();$toolbar.show();return false},g=function(){var a=d.find(".md-href"),c=d.find(".md-title"),e=a.val(),f=c.val()||e;k(b(f,e));m();d.remove();$toolbar.show();return false};$toolbar.hide().after(d);d.on("click",".md-btn-accept",g).on("click",".md-btn-cancel",e).on("keyup",".md-input",function(a){if(a.keyCode===13)g();else if(a.keyCode===27)e()});if(!c||/^http(s?):\/\//.exec(c)){d.find(".md-href").val(c);d.find(".md-title").focus()}else{d.find(".md-title").val(c);d.find(".md-href").focus()}};var u=function(a){var b=j(a.block).text;if(!a.block&&/\n/.exec(b))return;var c=a.regex.exec(b);var d=!c?a.modify(b):a.undo?a.undo(b,a):c[1];k(d,a.block)};var v=[{cmd:"b",handler:function(){u({modify:function(a){return"**"+a.trim()+"**"},regex:/^\*\*(.*)\*\*$/});m()}},{cmd:"i",handler:function(){u({modify:function(a){return"*"+a.trim()+"*"},regex:/^\*((\*\*)?([^*]*)(\*\*))?\*$/});m()}},{cmd:"a",shortcut:"⌘+k, ctrl+k",handler:function(){t(function(a,b){return"["+a+"]("+b+' "'+a+'")'})}},{cmd:"code",shortcut:"shift+⌘+p, shift+ctrl+p",handler:function(){u({modify:function(a){return"`"+a+"`"},regex:/^`([^`]*)`$/});m()}},{cmd:"blockquote",shortcut:"⌘+', ctrl+'",handler:function(){u({modify:function(a){return"> "+a.replace(/\n/g,"\n> ")},undo:function(a){return a.replace(/(^|\n)>[ \t]*(.*)/g,"$1$2")},regex:/((^|\n)>(.*))+$/,block:true});m()}},{cmd:"img",shortcut:"shift+⌘+i, shift+ctrl+i",handler:function(){t(function(a,b){return"!["+a+"]("+b+' "'+a+'")'})}},{cmd:"h",handler:function(){u({modify:function(a){return"#"+a},regex:/^#(.*)$/,block:true});m()}},{cmd:"ul",shortcut:"shift+⌘+l, shift+ctrl+l",handler:function(){u({modify:function(a){return"* "+a.replace(/\n/g,"\n* ")},undo:function(a){return a.replace(/^[\s\t]*\*[ \t]*/mg,"")},regex:/^([\s\t]*\*.*)*$/,block:true});m()}},{cmd:"undo",shortcut:"⌘+z, ctrl+z",handler:n},{cmd:"redo",shortcut:"⌘+y, ctrl+y",handler:o},{cmd:"help",shortcut:"shift+⌘+h, shift+ctrl+h",handler:function(){window.open("http://en.wikipedia.org/wiki/Markdown")}}];key.filter=function(a){var b=(a.target||a.srcElement).tagName;return!(b=="INPUT"||b=="SELECT")};for(var w=0;w<v.length;w++){var x=v[w],y=x.cmd,z=x.handler;$toolbar.on("click",".md-btn-"+y,z);key(x.shortcut||"⌘+"+y+", ctrl+"+y,"markdown",z)}$editor.focusin(function(){key.setScope("markdown")}).focusout(function(){key.setScope()});if(b.internals){var w=b.internals;w.pushHistory=m;w.popHistory=n;w.history=c}b.value&&$editor.val(b.value);$editor.input(m);c[d]=g.value;q(true);s.attr("disabled","");r.attr("disabled","");this.html($container)}})(jQuery)